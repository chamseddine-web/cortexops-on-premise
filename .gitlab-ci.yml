# GitLab CI/CD Pipeline for CortexOps
# Automated testing, building, and deployment

stages:
  - test
  - build
  - deploy
  - validate

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

# Cache node_modules for faster builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .npm/

# Lint and test
lint:
  stage: test
  image: node:20-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - npm run lint
    - echo "✅ Linting passed"
  only:
    - merge_requests
    - main
    - develop
  artifacts:
    reports:
      junit: lint-results.xml

# Type check
typecheck:
  stage: test
  image: node:20-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - npm run typecheck
    - echo "✅ Type checking passed"
  only:
    - merge_requests
    - main
    - develop

# Security scan
security-scan:
  stage: test
  image: node:20-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - npm audit --audit-level=moderate
    - echo "✅ Security scan passed"
  allow_failure: true
  only:
    - merge_requests
    - main

# Build application
build:
  stage: build
  image: node:20-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - npm run build
    - echo "✅ Build successful"
    - ls -lah dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - main
    - develop
    - tags

# Build Docker image
docker-build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - docker push $IMAGE_NAME:latest
    - echo "✅ Docker image pushed"
  only:
    - main
    - tags
  dependencies:
    - build

# Deploy to staging
deploy-staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $STAGING_HOST >> ~/.ssh/known_hosts
  script:
    - |
      ssh $STAGING_USER@$STAGING_HOST << EOF
        cd /opt/cortexops
        docker-compose pull
        docker-compose up -d
        docker-compose ps
      EOF
    - echo "✅ Deployed to staging"
  environment:
    name: staging
    url: https://staging.cortexops.com
  only:
    - develop
  dependencies:
    - docker-build
  when: manual

# Deploy to production
deploy-production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $PRODUCTION_HOST >> ~/.ssh/known_hosts
  script:
    - |
      ssh $PRODUCTION_USER@$PRODUCTION_HOST << EOF
        cd /opt/cortexops
        docker-compose pull
        docker-compose up -d --no-deps cortexops-web
        docker-compose ps
        sleep 10
        curl -f http://localhost/health || exit 1
      EOF
    - echo "✅ Deployed to production"
  environment:
    name: production
    url: https://cortexops.com
  only:
    - main
    - tags
  dependencies:
    - docker-build
  when: manual

# Validate deployment
validate-deployment:
  stage: validate
  image: curlimages/curl:latest
  script:
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        URL="https://cortexops.com"
      else
        URL="https://staging.cortexops.com"
      fi
    - echo "Validating $URL"
    - curl -f $URL/health || exit 1
    - echo "✅ Deployment validated"
  only:
    - main
    - develop
  dependencies: []
  needs:
    - job: deploy-staging
      optional: true
    - job: deploy-production
      optional: true

# Notify on success
notify-success:
  stage: .post
  image: curlimages/curl:latest
  script:
    - |
      curl -X POST $SLACK_WEBHOOK_URL \
        -H 'Content-Type: application/json' \
        -d "{
          \"text\": \"✅ CortexOps deployed successfully\",
          \"blocks\": [{
            \"type\": \"section\",
            \"text\": {
              \"type\": \"mrkdwn\",
              \"text\": \"*CortexOps Deployment*\n\n• Branch: \`$CI_COMMIT_REF_NAME\`\n• Commit: \`$CI_COMMIT_SHORT_SHA\`\n• Pipeline: <$CI_PIPELINE_URL|#$CI_PIPELINE_ID>\n• Status: ✅ *Success*\"
            }
          }]
        }"
  when: on_success
  only:
    - main
    - develop

# Notify on failure
notify-failure:
  stage: .post
  image: curlimages/curl:latest
  script:
    - |
      curl -X POST $SLACK_WEBHOOK_URL \
        -H 'Content-Type: application/json' \
        -d "{
          \"text\": \"❌ CortexOps deployment failed\",
          \"blocks\": [{
            \"type\": \"section\",
            \"text\": {
              \"type\": \"mrkdwn\",
              \"text\": \"*CortexOps Deployment*\n\n• Branch: \`$CI_COMMIT_REF_NAME\`\n• Commit: \`$CI_COMMIT_SHORT_SHA\`\n• Pipeline: <$CI_PIPELINE_URL|#$CI_PIPELINE_ID>\n• Status: ❌ *Failed*\"
            }
          }]
        }"
  when: on_failure
  only:
    - main
    - develop
